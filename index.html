<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>나만의 블로그</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f0f4f8; color:#333; }
    .container { max-width:800px; margin:auto; }
    .header-bg { background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); }
    .blog-card { transition:transform 0.2s, box-shadow 0.2s; }
    .blog-card:hover { transform:translateY(-5px); box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); }
  </style>
</head>
<body class="bg-gray-100">

  <!-- 헤더 -->
  <header class="header-bg text-white py-16 rounded-b-3xl text-center">
    <div class="container px-4">
      <h1 class="text-5xl font-bold">나만의 블로그</h1>
      <p class="mt-3 opacity-90">생각과 경험을 공유하세요</p>
    </div>
  </header>

  <main class="container px-4 py-12 -mt-12">
    <!-- 로그인 상태 -->
    <section class="bg-white p-6 rounded-2xl shadow-lg mb-8 flex items-center justify-between">
      <span id="user-info" class="text-sm text-gray-600">로그인 상태 확인 중...</span>
      <button id="auth-button" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-full hover:bg-blue-700">로그인</button>
    </section>

    <!-- 글쓰기 버튼 -->
    <section id="write-post-section" class="bg-white p-6 rounded-2xl shadow-lg mb-8 hidden">
      <button id="new-post-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-full hover:bg-green-600">새 글 작성</button>
    </section>

    <!-- 글쓰기 모달 -->
    <div id="post-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4 hidden">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6">
        <h2 class="text-2xl font-bold mb-4" id="modal-title">새 글 작성</h2>
        <form id="post-form">
          <input type="hidden" id="post-id">
          <div class="mb-4">
            <label class="block mb-1">제목</label>
            <input type="text" id="post-title" class="w-full border rounded-lg p-2" required>
          </div>
          <div class="mb-4">
            <label class="block mb-1">내용</label>
            <textarea id="post-content" rows="6" class="w-full border rounded-lg p-2" required></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="close-modal-btn" class="bg-gray-300 px-4 py-2 rounded-full">취소</button>
            <button type="submit" id="save-post-btn" class="bg-blue-600 text-white px-4 py-2 rounded-full">저장</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 게시물 목록 -->
    <section id="blog-posts-list" class="grid grid-cols-1 gap-8"></section>
  </main>

  <!-- 푸터 -->
  <footer class="bg-gray-800 text-white text-center py-6 mt-12 rounded-t-3xl">
    <p class="text-sm opacity-70">&copy; 2025 My Blog</p>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

    // Firebase 설정 (본인 프로젝트 값으로 교체)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authButton = document.getElementById('auth-button');
    const userInfoSpan = document.getElementById('user-info');
    const writePostSection = document.getElementById('write-post-section');
    const newPostBtn = document.getElementById('new-post-btn');
    const postModal = document.getElementById('post-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const postForm = document.getElementById('post-form');
    const blogPostsList = document.getElementById('blog-posts-list');
    const modalTitle = document.getElementById('modal-title');
    const postIdInput = document.getElementById('post-id');

    let userId = null;

    // 로그인/로그아웃 버튼
    authButton.addEventListener('click', async () => {
      if (auth.currentUser) {
        await signOut(auth);
      } else {
        try {
          await signInAnonymously(auth);
          console.log("익명 로그인 성공");
        } catch (e) {
          console.error("익명 로그인 실패:", e);
        }
      }
    });

    // 로그인 상태 감지
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        userInfoSpan.textContent = `익명 로그인됨 (UID: ${userId})`;
        authButton.textContent = "로그아웃";
        writePostSection.classList.remove('hidden');
        loadPosts();
      } else {
        userId = null;
        userInfoSpan.textContent = "로그아웃됨";
        authButton.textContent = "로그인";
        writePostSection.classList.add('hidden');
        blogPostsList.innerHTML = "";
      }
    });

    // 새 글 버튼
    newPostBtn.addEventListener('click', () => {
      modalTitle.textContent = "새 글 작성";
      postForm.reset();
      postIdInput.value = "";
      postModal.classList.remove('hidden');
    });

    // 모달 닫기
    closeModalBtn.addEventListener('click', () => postModal.classList.add('hidden'));

    // 글 저장
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const postId = postIdInput.value;
      const title = document.getElementById('post-title').value;
      const content = document.getElementById('post-content').value;

      if (postId) {
        const postRef = doc(db, "blog_posts", postId);
        await updateDoc(postRef, { title, content });
      } else {
        await addDoc(collection(db, "blog_posts"), {
          title, content,
          authorId: userId,
          createdAt: serverTimestamp()
        });
      }
      postModal.classList.add('hidden');
    });

    // 게시물 불러오기
    function loadPosts() {
      const postsRef = collection(db, "blog_posts");
      const q = query(postsRef, orderBy("createdAt", "desc"));

      onSnapshot(q, (snapshot) => {
        blogPostsList.innerHTML = "";
        if (snapshot.empty) {
          blogPostsList.innerHTML = '<p class="text-center text-gray-500">아직 글이 없습니다.</p>';
        } else {
          snapshot.forEach((docSnap) => {
            const post = docSnap.data();
            const postId = docSnap.id;
            const date = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString("ko-KR") : "날짜 없음";

            const div = document.createElement("div");
            div.className = "bg-white p-8 rounded-2xl shadow-lg blog-card";
            div.innerHTML = `
              <h2 class="text-2xl font-semibold mb-2">${post.title}</h2>
              <p class="text-sm text-gray-500 mb-4">${date}</p>
              <p class="text-gray-700 leading-relaxed mb-4 post-content">${post.content}</p>
              <div class="flex gap-2">
                <button class="edit-btn text-blue-600 hover:underline" data-id="${postId}">수정</button>
                <button class="delete-btn text-red-600 hover:underline" data-id="${postId}">삭제</button>
              </div>
            `;
            blogPostsList.appendChild(div);
          });

          // 수정
          document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = e.target.dataset.id;
              const card = e.target.closest('.blog-card');
              const title = card.querySelector('h2').textContent;
              const content = card.querySelector('.post-content').textContent;

              postIdInput.value = id;
              document.getElementById('post-title').value = title;
              document.getElementById('post-content').value = content;
              modalTitle.textContent = "글 수정";
              postModal.classList.remove('hidden');
            });
          });

          // 삭제
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.target.dataset.id;
              if (confirm("정말 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, "blog_posts", id));
              }
            });
          });
        }
      });
    }
  </script>
</body>
</html>
